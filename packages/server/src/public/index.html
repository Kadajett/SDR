<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>SDR - Steam Deck Randomizer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a2e; color: #eee; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; }
  #loading h1 { font-size: 1.8em; margin-bottom: 10px; color: #e94560; }
  #loading .desc { font-size: 1em; color: #aaa; margin-bottom: 15px; max-width: 500px; }
  #loading .controls { font-size: 0.85em; color: #888; margin-bottom: 10px; }
  #loading .howto { font-size: 0.85em; color: #888; margin-bottom: 20px; }
  #loading .status { font-size: 0.9em; color: #e94560; }
  #loading button { padding: 15px 40px; font-size: 1.2em; background: #e94560; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; }
  #loading button:active { background: #c73650; }
  #game-container { width: 100vw; height: 100vh; display: none; }
  #game-container canvas { display: block; width: 100% !important; height: 100% !important; object-fit: contain; }
</style>
</head>
<body>
<div id="loading">
  <h1 id="title">Loading...</h1>
  <div class="desc" id="desc"></div>
  <div class="controls" id="controls"></div>
  <div class="howto" id="howto"></div>
  <div class="status" id="status">Fetching today's game...</div>
  <button id="play-btn" style="display:none" onclick="startGame()">Play</button>
</div>
<div id="game-container"></div>

<script src="https://unpkg.com/colyseus.js@0.15.28/dist/colyseus.js"></script>
<script>
  let gameMetadata = null;
  let colyseusRoom = null;

  async function init() {
    try {
      const resp = await fetch('/api/games/current');
      const data = await resp.json();
      gameMetadata = data.game;

      if (!gameMetadata) {
        document.getElementById('status').textContent = 'No game available today!';
        return;
      }

      document.getElementById('title').textContent = gameMetadata.title;
      document.getElementById('desc').textContent = gameMetadata.description;
      document.getElementById('controls').textContent = 'ðŸŽ® ' + gameMetadata.controls;
      document.getElementById('howto').textContent = 'ðŸ“– ' + gameMetadata.howToPlay;
      document.getElementById('status').textContent = 'Ready to play!';
      document.getElementById('play-btn').style.display = 'inline-block';
    } catch (e) {
      document.getElementById('status').textContent = 'Error: ' + e.message;
    }
  }

  async function startGame() {
    const status = document.getElementById('status');
    const playBtn = document.getElementById('play-btn');
    playBtn.style.display = 'none';
    status.textContent = 'Connecting to server...';

    try {
      // Connect to Colyseus
      const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const client = new Colyseus.Client(wsProtocol + '//' + location.host);
      colyseusRoom = await client.joinOrCreate('game', {
        gameDate: gameMetadata.date
      });
      window.colyseusRoom = colyseusRoom;

      status.textContent = 'Loading game...';

      // Hide loading, show game container
      document.getElementById('loading').style.display = 'none';
      document.getElementById('game-container').style.display = 'block';

      // Dynamically import the game module
      const gameModule = await import('/games/' + gameMetadata.date + '/client/game.js');

      // Call the launch function with the container element
      if (gameModule.launch) {
        gameModule.launch('game-container');
      } else {
        status.textContent = 'Error: game has no launch function';
      }
    } catch (e) {
      status.textContent = 'Error: ' + e.message;
      playBtn.style.display = 'inline-block';
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('game-container').style.display = 'none';
      console.error(e);
    }
  }

  init();
</script>
</body>
</html>
