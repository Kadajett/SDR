<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>SDR - Steam Deck Randomizer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a2e; color: #eee; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; }
  #loading h1 { font-size: 1.8em; margin-bottom: 10px; color: #e94560; }
  #loading .desc { font-size: 1em; color: #aaa; margin-bottom: 15px; max-width: 500px; }
  #loading .controls { font-size: 0.85em; color: #888; margin-bottom: 10px; }
  #loading .howto { font-size: 0.85em; color: #888; margin-bottom: 20px; }
  #loading .status { font-size: 0.9em; color: #e94560; }
  #loading button { padding: 15px 40px; font-size: 1.2em; background: #e94560; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; }
  #loading button:active { background: #c73650; }
  #game-container { width: 100vw; height: 100vh; display: none; position: relative; }
  #game-container canvas { display: block; width: 100% !important; height: 100% !important; object-fit: contain; }
  /* Virtual touch controls - Steam Deck layout */
  #touch-controls { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; pointer-events: none; }
  /* Left stick */
  #joystick-zone { position: fixed; bottom: 40px; left: 30px; width: 130px; height: 130px; pointer-events: all; }
  #joystick-base { width: 130px; height: 130px; border-radius: 50%; background: rgba(255,255,255,0.10); border: 2px solid rgba(255,255,255,0.22); position: absolute; }
  #joystick-thumb { width: 52px; height: 52px; border-radius: 50%; background: rgba(233,69,96,0.75); position: absolute; top: 39px; left: 39px; }
  /* Right stick */
  #joystick-right-zone { position: fixed; bottom: 40px; right: 190px; width: 100px; height: 100px; pointer-events: all; }
  #joystick-right-base { width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.18); position: absolute; }
  #joystick-right-thumb { width: 40px; height: 40px; border-radius: 50%; background: rgba(100,180,255,0.7); position: absolute; top: 30px; left: 30px; }
  /* Face buttons (ABXY) - right side diamond */
  .facebtn { position: fixed; width: 56px; height: 56px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); color: white; font-size: 0.85em; font-weight: bold; display: flex; align-items: center; justify-content: center; pointer-events: all; user-select: none; -webkit-user-select: none; }
  #btn-a { background: rgba(100,200,100,0.8); bottom: 40px; right: 40px; }
  #btn-b { background: rgba(233,69,96,0.8); bottom: 100px; right: 10px; }
  #btn-x { background: rgba(100,130,220,0.8); bottom: 100px; right: 72px; }
  #btn-y { background: rgba(220,180,50,0.8); bottom: 160px; right: 40px; }
  /* Shoulder buttons */
  .shoulderbtn { position: fixed; pointer-events: all; user-select: none; -webkit-user-select: none; background: rgba(80,80,80,0.85); border: 2px solid rgba(255,255,255,0.2); color: white; font-size: 0.75em; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
  #btn-l1 { width: 70px; height: 36px; top: 10px; left: 10px; }
  #btn-r1 { width: 70px; height: 36px; top: 10px; right: 10px; }
  #btn-l2 { width: 60px; height: 30px; top: 52px; left: 15px; background: rgba(60,60,100,0.85); }
  #btn-r2 { width: 60px; height: 30px; top: 52px; right: 15px; background: rgba(60,60,100,0.85); }
</style>
</head>
<body>
<div id="loading">
  <h1 id="title">Loading...</h1>
  <div class="desc" id="desc"></div>
  <div class="controls" id="controls"></div>
  <div class="howto" id="howto"></div>
  <div class="status" id="status">Fetching today's game...</div>
  <button id="play-btn" style="display:none" onclick="startGame()">Play</button>
</div>
<div id="game-container"></div>

<!-- Virtual touch controls - Steam Deck layout (shown on mobile) -->
<div id="touch-controls">
  <!-- Left stick -->
  <div id="joystick-zone">
    <div id="joystick-base"></div>
    <div id="joystick-thumb"></div>
  </div>
  <!-- Right stick -->
  <div id="joystick-right-zone">
    <div id="joystick-right-base"></div>
    <div id="joystick-right-thumb"></div>
  </div>
  <!-- Face buttons ABXY -->
  <div id="btn-a" class="facebtn">A</div>
  <div id="btn-b" class="facebtn">B</div>
  <div id="btn-x" class="facebtn">X</div>
  <div id="btn-y" class="facebtn">Y</div>
  <!-- Shoulder / trigger buttons -->
  <div id="btn-l1" class="shoulderbtn">L1</div>
  <div id="btn-r1" class="shoulderbtn">R1</div>
  <div id="btn-l2" class="shoulderbtn">L2</div>
  <div id="btn-r2" class="shoulderbtn">R2</div>
</div>

<script>
  const isMobile = /Android|iPhone|iPad|iPod|Touch/i.test(navigator.userAgent) || ('ontouchstart' in window);
  let gameMetadata = null;

  // Virtual input state â€” exposed globally so game.js can read it
  window.touchInput = {
    x: 0, y: 0,       // left stick
    rx: 0, ry: 0,     // right stick
    buttons: { a: false, b: false, x: false, y: false, l1: false, r1: false, l2: false, r2: false, space: false, action: false, start: false, select: false }
  };

  function makeJoystick(zoneId, thumbId, radius, onMove, onReset) {
    const zone = document.getElementById(zoneId);
    const thumb = document.getElementById(thumbId);
    const center = radius - (thumb.offsetWidth || 40) / 2;
    let activeId = null, ox = 0, oy = 0;
    zone.addEventListener('touchstart', e => {
      e.preventDefault();
      const t = e.changedTouches[0];
      const r = zone.getBoundingClientRect();
      activeId = t.identifier; ox = r.left + r.width/2; oy = r.top + r.height/2;
    }, { passive: false });
    zone.addEventListener('touchmove', e => {
      e.preventDefault();
      for (const t of e.changedTouches) {
        if (t.identifier !== activeId) continue;
        let dx = t.clientX - ox, dy = t.clientY - oy;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > radius) { dx = dx/dist*radius; dy = dy/dist*radius; }
        thumb.style.left = (center + dx) + 'px'; thumb.style.top = (center + dy) + 'px';
        onMove(dx/radius, dy/radius);
      }
    }, { passive: false });
    const reset = e => {
      for (const t of e.changedTouches) {
        if (t.identifier !== activeId) continue;
        activeId = null;
        thumb.style.left = center + 'px'; thumb.style.top = center + 'px';
        onReset();
      }
    };
    zone.addEventListener('touchend', reset, { passive: false });
    zone.addEventListener('touchcancel', reset, { passive: false });
  }

  function makeButton(id, downKeys, upKeys) {
    const el = document.getElementById(id);
    if (!el) return;
    const set = (val) => { downKeys.forEach(k => window.touchInput.buttons[k] = val); };
    el.addEventListener('touchstart', e => { e.preventDefault(); set(true); }, { passive: false });
    el.addEventListener('touchend',   e => { e.preventDefault(); set(false); }, { passive: false });
    el.addEventListener('touchcancel',e => { e.preventDefault(); set(false); }, { passive: false });
  }

  function initTouchControls() {
    if (!isMobile) return;
    document.getElementById('touch-controls').style.display = 'block';
    // Left stick
    makeJoystick('joystick-zone', 'joystick-thumb', 39,
      (x, y) => { window.touchInput.x = x; window.touchInput.y = y; },
      ()      => { window.touchInput.x = 0; window.touchInput.y = 0; }
    );
    // Right stick
    makeJoystick('joystick-right-zone', 'joystick-right-thumb', 30,
      (x, y) => { window.touchInput.rx = x; window.touchInput.ry = y; },
      ()      => { window.touchInput.rx = 0; window.touchInput.ry = 0; }
    );
    // Face buttons
    makeButton('btn-a', ['a', 'action']);
    makeButton('btn-b', ['b']);
    makeButton('btn-x', ['x']);
    makeButton('btn-y', ['y']);
    // Shoulder / triggers
    makeButton('btn-l1', ['l1']);
    makeButton('btn-r1', ['r1']);
    makeButton('btn-l2', ['l2']);
    makeButton('btn-r2', ['r2', 'space']);
  }


  async function init() {
    try {
      const resp = await fetch('/api/games/current');
      const data = await resp.json();
      gameMetadata = data.game;

      if (!gameMetadata) {
        document.getElementById('status').textContent = 'No game available today!';
        return;
      }

      document.getElementById('title').textContent = gameMetadata.title;
      document.getElementById('desc').textContent = gameMetadata.description;
      document.getElementById('controls').textContent = 'ðŸŽ® ' + gameMetadata.controls;
      document.getElementById('howto').textContent = 'ðŸ“– ' + gameMetadata.howToPlay;
      document.getElementById('status').textContent = 'Ready to play!';
      document.getElementById('play-btn').style.display = 'inline-block';
    } catch (e) {
      document.getElementById('status').textContent = 'Error loading game info: ' + e.message;
    }
  }

  async function startGame() {
    const status = document.getElementById('status');
    const playBtn = document.getElementById('play-btn');
    playBtn.style.display = 'none';
    status.textContent = 'Loading game...';

    try {
      // Hide loading, show game container
      document.getElementById('loading').style.display = 'none';
      document.getElementById('game-container').style.display = 'block';

      // Init touch controls if on mobile
      initTouchControls();

      // Dynamically import the game module (ES module bundle)
      const gameModule = await import('/games/' + gameMetadata.date + '/client/game.js');

      // Call the launch function with the container element
      if (gameModule.launch) {
        gameModule.launch('game-container', { isMobile, touchInput: window.touchInput });
      } else if (gameModule.default) {
        // Fallback: if only default export, try to use it
        console.log('No launch function found, using default export');
      } else {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('game-container').style.display = 'none';
        status.textContent = 'Error: game has no launch function';
      }
    } catch (e) {
      status.textContent = 'Error: ' + e.message;
      playBtn.style.display = 'inline-block';
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('game-container').style.display = 'none';
      console.error('Game load error:', e);
    }
  }

  init();
</script>
</body>
</html>
